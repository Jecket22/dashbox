<?php
// this shit borked
exit("1:62282482:2:DEAD BEAT:5:1:6:28770186:8:10:9:30:10:94536:12:0:13:21:14:2990:17:1:43:0:25::18:10:19:24971:42:1:45:56373:3:YWZ0ZXIgdGhyZWUgbW9udGhzIG9mIGhhcmQgd29yayBpIGZpbmFsbHkgcHJlc2VudCB0byB5b3UgdGhlIGxvbmcgYXdhaXRlZCBzZXF1ZWwgdG8gbXVyZGVyIG1lbG9keQ==:15:3:30:60376208:31:0:37:1:38:1:39:10:46:1:47:2:35:541786|1:62028241:2:Eternelle Vehemence:5:14:6:4761912:8:10:9:30:10:89174:12:0:13:21:14:5187:17:1:43:0:25::18:10:19:24968:42:1:45:65535:3:c3VmZmVyLCB1bnRpbCBldGVybml0eSBlbmRzLg==:15:4:30:0:31:0:37:3:38:1:39:10:46:1:47:2:35:896821|1:60927712:2:PERIHELION:5:1:6:9456326:8:10:9:30:10:8864:12:0:13:21:14:725:17:1:43:0:25::18:10:19:24970:42:1:45:65535:3:VG9vayBmb3JldmVyIHRvIG1ha2UsICBidXQgaXQgaXMgZmluYWxseSBoZXJlLiBSZWxsIC0gU21pbnggLSBHYWx6byAtIFdoaXRlaGVhZCAtIFNwdTduaXggLSBXaWsgLSBLbm90cyAtIEh5cGVyZmxhbWU=:15:3:30:51261866:31:0:37:0:38:1:39:10:46:1:47:2:35:790560|1:59502709:2:Supreme:5:4:6:2595697:8:10:9:30:10:48776:12:0:13:21:14:2471:17:1:43:0:25::18:10:19:24956:42:1:45:65535:3:aW5zZXJ0ICQzNTAgVVNEIHRvIHBsYXkgW0J5IENyZXBlcyAmIEVuWm9yZV0gZml4ZWQgYnVuY2ggb2YgYnVncyBhcm91bmQgOTAlICwgYW5kIGFkZGVkIFVMRE0gd2hlbiB5b3UgYWN0aXZhdGUgTERNICwgdXBkYXRlcyBjb21pbmcgc29vbg==:15:3:30:58794967:31:0:37:2:38:1:39:10:46:1:47:2:35:754856|1:59413155:2:HASH:5:1:6:1424041:8:10:9:30:10:28010:12:0:13:21:14:1576:17:1:43:0:25::18:10:19:24953:42:1:45:52312:3:YSBsZXZlbCB3aXRoIG1hbnkgY29sb3Vycy4=:15:3:30:52863418:31:0:37:0:38:0:39:10:46:1:47:2:35:216300|1:59352979:2:RANYER:5:5:6:9441630:8:10:9:30:10:93328:12:0:13:21:14:3681:17:1:43:0:25::18:10:19:24949:42:1:45:65535:3:YW1hemluZyBjb2xsYWJvcmF0aW9uIC4uIEkgaG9wZSB5b3UgbGlrZSBpdCAuLi4gd2l0aCBhIGxvdCBvZiBkZWRpY2F0aW9uIHdlIGJyaW5nIHlvdSByYW55ZXIgOikgZ29vZCBsdWNrIGFuZCBlbmpveSBpdCArOTAwMDAgT0JKIDowIExETT8gOyk=:15:3:30:59193188:31:0:37:1:38:1:39:10:46:1:47:2:35:658059|1:59315849:2:Double Dash:5:5:6:3624826:8:10:9:30:10:102653:12:0:13:21:14:11269:17:1:43:0:25::18:10:19:24953:42:1:45:65535:3:IkR1YWwgZ2FtZW1vZGUgaXMgdGhlIGJlc3QgZ2FtZW1vZGUiIH4gSm9uYXRoYW5HRCB8IEEgY29sb3JmdWwgMiBtaW51dGVzIG9mIG9ubHkgZHVhbHMgKCsgcGxheWVyIGNvbG9ycykgfCBHTCwgSEYsIGRvbid0IGRpZSBhdCA5OSUgOCk=:15:4:30:0:31:0:37:0:38:0:39:10:46:1:47:2:35:872453|1:59309294:2:Archaic:5:6:6:13003836:8:10:9:30:10:33708:12:0:13:21:14:1700:17:1:43:0:25::18:10:19:24949:42:1:45:65535:3:QW1hemluZyBjb2xsYWIgd2l0aCBWbGFpbmUgYW5kIE1yY3lsZGUsIGdhbWVwbGF5IGJ5IEVuem9yZSBhbmQgR2FycC4gRW5qb3l5ISE=:15:3:30:59045071:31:0:37:0:38:0:39:10:46:1:47:2:35:791611|1:58994346:2:Agios:5:2:6:18682953:8:10:9:30:10:67315:12:0:13:21:14:2226:17:1:43:0:25::18:10:19:24940:42:1:45:65535:3:N3RoIE5veHR1cm5hbCBUZWFtIE1DLCBXZSB1c2UgYSBsaXR0bGUgbmljZSB0aGVtZSBpbiB0aGlzISEgIEhvcGUgeW91IGVuam95IG91ciB3b3JrLi4gIFtWZXJpZmllZCBieSBTaXJaYWlzc10=:15:3:30:58581054:31:0:37:0:38:0:39:10:46:1:47:2:35:728233|1:58932971:2:Divine Descendance:5:5:6:11876184:8:10:9:30:10:11239:12:0:13:21:14:882:17:1:43:0:25::18:10:19:24960:42:1:45:65535:3:VmVyaWZpZWQgYnkgaVRodW5kZXIxMiwgdmlkZW8gb24gaGlzIFlUIGNoYW5uZWw=:15:3:30:0:31:0:37:3:38:1:39:10:46:1:47:2:35:713127#1424041:flash:127035|2595697:CrispyCrepes:117663|3624826:Zoroa:44967|4761912:Vrymer:411964|9441630:CatronixGD:1462499|9456326:Galzo:1463681|11876184:TroxxP1:2638799|13003836:SirZaiss:3749813|18682953:TeamNoX:5594928|28770186:swwft:6434750#1~|~216300~|~2~|~Necromancy (drum n bass)~|~3~|~772~|~4~|~zirconmusic~|~5~|~6.15~|~6~|~~|~10~|~http%3A%2F%2Faudio.ngfiles.com%2F216000%2F216300_04___Necromancy.mp3~|~7~|~~|~8~|~1~:~1~|~541786~|~2~|~NK - Fairydust~|~3~|~1895~|~4~|~Rukkus~|~5~|~7.37~|~6~|~~|~10~|~http%3A%2F%2Faudio.ngfiles.com%2F541000%2F541786_NK---Fairydust.mp3~|~7~|~~|~8~|~1~:~1~|~658059~|~2~|~Pursuit~|~3~|~2787~|~4~|~BoomKitty~|~5~|~7.28~|~6~|~~|~10~|~http%3A%2F%2Faudio.ngfiles.com%2F658000%2F658059_Pursuit.mp3~|~7~|~UCwHQ93ecuoQne93sgY-x8Nw~|~8~|~1~:~1~|~713127~|~2~|~Synergetic Enigma~|~3~|~1861~|~4~|~DanJohansen~|~5~|~10.21~|~6~|~~|~10~|~http%3A%2F%2Faudio.ngfiles.com%2F713000%2F713127_Synergetic-Enigma.mp3~|~7~|~~|~8~|~1~:~1~|~728233~|~2~|~FWLR - Badass Bae~|~3~|~50638~|~4~|~FWLRmusic~|~5~|~7.75~|~6~|~~|~10~|~https%3A%2F%2Faudio.ngfiles.com%2F728000%2F728233_FWLR---Badass-Bae.mp3%3Ff1486917017~|~7~|~~|~8~|~1~:~1~|~754856~|~2~|~[Complextro] Viscerality - Upgrade~|~3~|~48232~|~4~|~VisceralSounds~|~5~|~11.22~|~6~|~~|~10~|~http%3A%2F%2Faudio.ngfiles.com%2F754000%2F754856_Complextro-Viscerality---U.mp3~|~7~|~~|~8~|~1~:~1~|~790560~|~2~|~Forgathering Firefly~|~3~|~47526~|~4~|~Codly~|~5~|~12.79~|~6~|~~|~10~|~https%3A%2F%2Faudio.ngfiles.com%2F790000%2F790560_Forgathering-Firefly.mp3%3Ff1518710297~|~7~|~~|~8~|~1~:~1~|~791611~|~2~|~Viscerality - Bliss [Intervention EP]~|~3~|~48232~|~4~|~VisceralSounds~|~5~|~10.38~|~6~|~~|~10~|~https%3A%2F%2Faudio.ngfiles.com%2F791000%2F791611_Viscerality---Bliss-Interv.mp3%3Ff1519159342~|~7~|~~|~8~|~1~:~1~|~872453~|~2~|~Shining Sprinter~|~3~|~1068~|~4~|~megawolf77~|~5~|~3.51~|~6~|~~|~10~|~https%3A%2F%2Faudio.ngfiles.com%2F872000%2F872453_Shining-Sprinter.mp3%3Ff1562814299~|~7~|~~|~8~|~1~:~1~|~896821~|~2~|~Panda Eyes - Anybody Else~|~3~|~45754~|~4~|~PandaEyesOfficial~|~5~|~13.92~|~6~|~~|~10~|~https%3A%2F%2Faudio.ngfiles.com%2F896000%2F896821_Panda-Eyes---Anybody-Else.mp3%3Ff1575713545~|~7~|~~|~8~|~1#91:0:10#2a84bec46c4d1304c17b4c73252faf92be4dac24");

require (__DIR__) . "/../lib/constants.php";
if ($_POST["secret"] != Secrets::$commonSecret)
	exit(GenericResponse::$Error);

require (__DIR__) . "/../lib/utils.php";
// a bunch of variables, oh j
$type = (isset($_POST["type"]) && is_numeric($_POST["type"])) ? $_POST["type"] : 0;
$diff = isset($_POST["diff"]) ? Utils::CleanNumbers($_POST["type"]) : 0; // check later with empty($diff) for WHERE query
$page = (isset($_POST["page"]) && is_numeric($_POST["page"])) ? $_POST["page"] . "0" : 0;
$searchString = isset($_POST["str"]) ? Utils::CleanString($_POST["str"]) : false;
$queryParams = ["unlisted = 0"];
$queryOrder = "uploadDate";

require (__DIR__) . "/levelLib.php";
// Difficulty detection... oh j
// TODO: improve this, finish this, STOP USING STRINGS AS KEYS
switch ($diff) {
	case -2: // Demon levels
		$demonFilter = (!empty($_POST["demonFilter"])) ? Utils::CleanNumbers($_POST["demonFilter"]) : 0;
		$queryParams[] = "difficulty = 'Demon'";
		if ($demonFilter > 0)
			$queryParams[] = "demonDiff = " . Difficulty::$demonFilterNameKeys[$demonFilter];
		break;
	case 0: // no difficulty check (any diff)
		break;
	default:
		$diffs = explode($diff, ",");
		$allDiffs = "";
		foreach ($diffs as $curDiff) {
			$allDiffs .= "'" . Difficulty::$nameKeys[$curDiff] . "', ";
		}
		$allDiffs = substr($allDiffs, 0, -3);
		$queryParams[] = "difficulty in ($allDiffs)";
		break;
}

require (__DIR__) . "/../lib/config.php";
// Set order/params depending on the search type
switch ($type) {
	case 15: // Geometry Dash World most liked
	case 2: // Search for Level Name or ID
	case 0: // Most liked
		$queryOrder = "likes";
		if (isset($searchString))
			// It's possible to search level with level IDs. We'll first list the level with the attached level ID, then levels with the same name as the search.
			$queryParams[] = (is_numeric($searchString) ? "id = '$searchString' OR " : "") . "name LIKE '%$searchString$%'";
		break;
	case 1: // Most downloaded
		$queryOrder = "downloads";
		break;
	case 3: // Trending
		$queryOrder = "likes";
		$levelsConfig = Config::GetConfig("levels");
		$queryParams[] = "uploadDate <= " . strtotime("-" . $levelsConfig["trendLevel"]) . " AND likes >= " . $levelsConfig["trendLikesReq"];
		break;
	/* case 4: // Recent - skipped because $queryOrder is already defined like this
		$queryOrder = "uploadDate";
		break; */
	case 5: // Levels by specific accID
		if (is_numeric($searchString))
			$queryParams[] = "accountID = '$searchString'";
		break;
	case 17: // duplicate?
	case 6: // Featured
		$queryParams[] = "featured = 1";
		$queryOrder = "rateDate DESC," . $queryOrder;
		// is there any sql magic so I don't need DESC every time I add another order type?
		// edit: might turn this into arrays so I can just later split it with commas just like $queryParams
		break;
	case 7: // Magic
		if (Config::GetVariable("levels", "manualMagicSection"))
			$queryParams[] = "inMagic = 1";
		else
			$queryOrder = "RAND()";
		$page = 0;
		break;
	/*case 8: // Moderator sent levels
		No code here because as far as I am aware there isn't a way to check in-game for sent levels.
		Maybe a special build of the game has this... A mod for GD could probably work too.
		For now It'll be blank.
		*/
	case 10: // Mappacks
		$queryOrder = "mappacks"; // TODO: Implement mappacks
		$queryParams[] = "id IN ($searchString)";
		break;
	case 11: // Awarded
		// Just like the magic tab, this is a tab people want to customize.
		// But for now it's like GMDPrivateServer.
		$queryOrder = "rateDate DESC," . $queryOrder;
		$queryParams[] = "NOT stars = 0";
		break;
	case 12: // Levels by people you have followed
		if (isset($_POST["followed"]))
			$following = Utils::CleanNumbers($_POST["followed"]);
			$queryParams[] = "userID IN ($following)"; // Self note, you can't follow green users.
			// ...well ok we will not implement green users anyway (as the time of writing).
		break;
	/*case 13: // Levels by friends
		nope
		*/
	case 16: // Hall of Fame
		if (Config::GetVariable("levels", "epicInHall"))
			$queryParams[] = "epic = 1";
		else
			$queryParams[] = "inHall = 1";
		$queryOrder = "rateDate DESC," . $queryOrder;
		break;
}

// TODO: Advanced options | Additional parameters (+)
// TODO: Actual query functionality
require (__DIR__) . "/../lib/database.php";